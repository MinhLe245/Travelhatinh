{% extends 'app/base.html' %}
{% load static %}
{% load custom_filters %}
{% load humanize %}

{% block checkout_content %}
<div class="container py-5">
  <div class="mb-3 text-start">
    <a href="{% url 'buytour' %}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left"></i> Quay l·∫°i
    </a>
  </div>

  <h2 class="fw-bold text-primary mb-4">X√°c nh·∫≠n ƒê·∫∑t Tour</h2>

  <form method="post" class="bg-white p-4 rounded shadow-sm">
    {% csrf_token %}

    <!-- TH√îNG TIN NG∆Ø·ªúI ƒê·∫∂T -->
    <h5 class="mb-3 text-secondary">Th√¥ng tin ng∆∞·ªùi ƒë·∫∑t</h5>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">H·ªç v√† t√™n</label>
        <input type="text" class="form-control" name="full_name" required value="{{ request.user.get_full_name }}">
      </div>
      <div class="col-md-6">
        <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
        <input type="text" class="form-control" name="phone" required placeholder="0123456789">
      </div>
      <div class="col-md-6">
        <label class="form-label">Email</label>
        <input type="email" class="form-control" name="email" required value="{{ request.user.email }}">
      </div>
      <div class="col-md-6">
        <label class="form-label">ƒê·ªãa ch·ªâ</label>
        <input type="text" class="form-control" name="address" required placeholder="Qu·∫≠n/Huy·ªán, T·ªânh/TP">
      </div>
    </div>

    <!-- DANH S√ÅCH TOUR -->
    <h5 class="mt-5 mb-3 text-secondary">Danh s√°ch Tour ƒë√£ ch·ªçn</h5>
    <div class="row g-4">
      {% for item in order.items.all %}
      <div class="col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm border-0 rounded-4">
          <img src="{{ item.tour.image.url }}" class="card-img-top rounded-top-4" style="height: 180px; object-fit: cover;">
          <div class="card-body">
            <h5 class="fw-bold">{{ item.tour.name }}</h5>
            <ul class="list-unstyled small text-muted">
              <li><strong>M√£ tour:</strong> {{ item.tour.code }}</li>
              <li><strong>Kh·ªüi h√†nh:</strong> {{ item.tour.start_date }}</li>
              <li><strong>ƒêi·ªÉm xu·∫•t ph√°t:</strong> 100 H√† Huy T·∫≠p, TP H√† Tƒ©nh</li>
              <li><strong>S·ªë ng∆∞·ªùi:</strong> {{ item.quantity }}</li>
              <li><strong>Gi√°:</strong> {{ item.total_price|vnd_format }} VNƒê</li>
            </ul>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- PH∆Ø∆†NG TH·ª®C THANH TO√ÅN -->
    <h5 class="mt-5 mb-3 text-secondary">Ph∆∞∆°ng th·ª©c thanh to√°n</h5>
    <div class="row">
      <div class="col-md-6">
        <div class="form-check border p-3 rounded bg-light">
          <input class="form-check-input" type="radio" name="payment_method" value="pay_20" required id="pay_20">
          <label class="form-check-label fw-semibold" for="pay_20">
            üí≥ Thanh to√°n tr∆∞·ªõc 20%
          </label>
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-check border p-3 rounded bg-light">
          <input class="form-check-input" type="radio" name="payment_method" value="pay_100" required id="pay_100">
          <label class="form-check-label fw-semibold" for="pay_100">
            ‚úÖ Thanh to√°n to√†n b·ªô 100%
          </label>
        </div>
      </div>
    </div>

    <!-- S·ªê TI·ªÄN C·∫¶N THANH TO√ÅN (JS c·∫≠p nh·∫≠t) -->
    <div id="amount-to-pay-box" class="mt-3 d-none">
      <h6 class="fw-semibold">üí∞ S·ªë ti·ªÅn c·∫ßn thanh to√°n:</h6>
      <h4 class="text-danger" id="amount-to-pay"></h4>
    </div>

    <!-- GHI CH√ö -->
 <div class="alert alert-info mt-3 rounded-4 shadow-sm">
  <i class="fas fa-info-circle me-2"></i>
  <strong>L∆∞u √Ω:</strong> 
  <ul class="mb-0">
    <li>Ch√∫ng t√¥i <u>ch·ªâ h·ªó tr·ª£ thanh to√°n online</u> th√¥ng qua chuy·ªÉn kho·∫£n ng√¢n h√†ng ho·∫∑c v√≠ ƒëi·ªán t·ª≠.</li>
    <li>N·∫øu b·∫°n ch·ªçn <strong>thanh to√°n tr∆∞·ªõc 20%</strong>, vui l√≤ng thanh to√°n online ƒë·ªÉ gi·ªØ ch·ªó. 
        <br>S·ªë ti·ªÅn c√≤n l·∫°i (80%) s·∫Ω ƒë∆∞·ª£c thanh to√°n tr·ª±c ti·∫øp t·∫°i vƒÉn ph√≤ng khi l√†m th·ªß t·ª•c kh·ªüi h√†nh.</li>
    <li>N·∫øu b·∫°n ch·ªçn <strong>thanh to√°n 100%</strong>, b·∫°n s·∫Ω ho√†n t·∫•t ƒë∆°n h√†ng v√† kh√¥ng c·∫ßn ƒë·∫øn vƒÉn ph√≤ng tr∆∞·ªõc chuy·∫øn ƒëi.</li>
  </ul>
</div>


    <!-- T·ªîNG GI√Å -->
    <div class="mt-4">
      <button type="submit" class="btn btn-success btn-lg mt-3 px-5 py-2">
        <i class="fas fa-check-circle me-2"></i> X√°c nh·∫≠n ƒë·∫∑t tour
      </button>
    </div>

    <!-- HI·ªÜN QR SAU KHI ƒê·∫∂T -->
    {% if show_qr %}
    <hr class="my-5">
    <div class="text-center">
      <h5 class="text-success fw-bold mb-3">
        Vui l√≤ng qu√©t m√£ QR ƒë·ªÉ thanh to√°n
        {% if payment_method == 'pay_20' %}20%{% else %}100%{% endif %}
      </h5>
      <p class="fs-5 mb-1">S·ªë ti·ªÅn c·∫ßn thanh to√°n:</p>
      <h4 class="text-danger">{{ amount_to_pay|floatformat:0|intcomma }} VNƒê</h4>
      <img src="{% static 'app/images/qrcode.png' %}" alt="QR thanh to√°n" class="img-fluid my-3" style="max-width: 250px;">
      <p class="text-muted small">Sau khi thanh to√°n, ƒë∆°n h√†ng s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω.</p>
    </div>
    {% endif %}
  </form>
</div>

<!-- SCRIPT: Hi·ªán s·ªë ti·ªÅn c·∫ßn thanh to√°n -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const total = {{ order.items.all|sum_total_price }};
    const pay20 = document.getElementById("pay_20");
    const pay100 = document.getElementById("pay_100");
    const box = document.getElementById("amount-to-pay-box");
    const text = document.getElementById("amount-to-pay");

    function formatCurrency(number) {
      return new Intl.NumberFormat('vi-VN').format(number) + " VNƒê";
    }

    function updateAmount(percent) {
      text.textContent = formatCurrency(Math.round(total * percent));
      box.classList.remove("d-none");
    }

    if (pay20 && pay100) {
      pay20.addEventListener("change", () => updateAmount(0.2));
      pay100.addEventListener("change", () => updateAmount(1));
    }
  });
</script>
{% endblock checkout_content %}
