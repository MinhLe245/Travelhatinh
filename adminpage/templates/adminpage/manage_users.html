{% extends 'adminpage/base.html' %}
{% load static %}

{% block test_sontent %}
<div class="container py-4">
  <h2 class="mb-4 text-primary">ğŸ‘¥ Quáº£n lÃ½ ngÆ°á»i dÃ¹ng</h2>

  <!-- Danh sÃ¡ch Admin -->
  <div class="card mb-4 shadow">
    <div class="card-header bg-primary text-white">ğŸ” Admin</div>
    <div class="card-body">
      <table class="table table-bordered">
        <thead><tr><th>ID</th><th>TÃ i khoáº£n</th><th>Email</th><th>Staff</th></tr></thead>
        <tbody id="admin-table">
          <tr><td colspan="4" class="text-center text-muted">â³ Äang táº£i...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Danh sÃ¡ch nhÃ³m -->
  <div class="card mb-4 shadow">
    <div class="card-header bg-info text-white">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ NhÃ³m</div>
    <div class="card-body">
      <ul class="list-group" id="group-list">
        <li class="list-group-item text-muted">â³ Äang táº£i...</li>
      </ul>
    </div>
  </div>

  <!-- Danh sÃ¡ch ngÆ°á»i dÃ¹ng thÆ°á»ng -->
  <div class="card shadow">
    <div class="card-header bg-secondary text-white">ğŸ‘¤ NgÆ°á»i dÃ¹ng thÆ°á»ng</div>
    <div class="card-body">
      <table class="table table-bordered">
        <thead>
          <tr><th>ID</th><th>TÃ i khoáº£n</th><th>Email</th><th>Staff</th><th>Group</th><th>Thao tÃ¡c</th></tr>
        </thead>
        <tbody id="normal-table">
          <tr><td colspan="6" class="text-center text-muted">â³ Äang táº£i...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
async function fetchData() {
  const res = await fetch("{% url 'api-users' %}", {
    credentials: 'same-origin'
  });

  if (!res.ok) {
    alert("âŒ KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u. HÃ£y Ä‘áº£m báº£o báº¡n Ä‘ang Ä‘Äƒng nháº­p vá»›i tÃ i khoáº£n cÃ³ quyá»n quáº£n trá»‹ (staff).");
    return;
  }

  const { normal_users, admin_users, all_groups } = await res.json();

  // Hiá»ƒn thá»‹ nhÃ³m
  const groupList = document.getElementById("group-list");
  groupList.innerHTML = all_groups.length
    ? all_groups.map(g => `<li class="list-group-item">${g.name}</li>`).join('')
    : '<li class="list-group-item text-muted">ChÆ°a cÃ³ nhÃ³m nÃ o.</li>';

  // Hiá»ƒn thá»‹ ngÆ°á»i dÃ¹ng
  renderTable('admin-table', admin_users);
  renderTable('normal-table', normal_users, all_groups);
}

function renderTable(tableId, users, groups = null) {
  const tbody = document.getElementById(tableId);
  tbody.innerHTML = '';

  if (!users.length) {
    tbody.innerHTML = `<tr><td colspan="${groups ? 6 : 4}" class="text-center text-muted">KhÃ´ng cÃ³ dá»¯ liá»‡u</td></tr>`;
    return;
  }

  users.forEach(u => {
    const isStaff = u.is_staff ? 'âœ…' : 'âŒ';
    const groupOptions = groups
      ? `<select id="grp-${u.id}" class="form-select form-select-sm"><option value="">--Chá»n--</option></select>`
      : 'â€”';

    const actions = groups ? `
      <button class="btn btn-sm btn-warning me-1" onclick="act(${u.id}, 'toggle_staff')">${u.is_staff ? 'Thu há»“i staff' : 'Cáº¥p staff'}</button>
      <button class="btn btn-sm btn-danger" onclick="act(${u.id}, 'delete')">XoÃ¡</button>
    ` : '';

    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${u.id}</td>
        <td>${u.username}</td>
        <td>${u.email}</td>
        <td>${isStaff}</td>
        <td>${groupOptions}</td>
        <td>${actions}</td>
      </tr>
    `);

    if (groups) setupGroupSelect(u, groups);
  });
}

function setupGroupSelect(user, groups) {
  const sel = document.getElementById(`grp-${user.id}`);
  groups.forEach(g => {
    const opt = new Option(g.name, g.name);
    if (user.group_names && user.group_names.includes(g.name)) opt.selected = true;
    sel.add(opt);
  });

  sel.onchange = () => {
    const selected = sel.value;
    const action = selected ? 'add_group' : 'remove_group';
    act(user.id, action, selected);
  };
}

async function act(userId, action, group = null) {
  const res = await fetch("{% url 'api-users-action' %}", {
    method: "POST",
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({ id: userId, action, group })
  });

  if (res.ok) {
    fetchData();
  } else {
    const data = await res.json();
    alert(`âŒ Lá»—i: ${data.error || 'KhÃ´ng thá»ƒ thá»±c hiá»‡n thao tÃ¡c'}`);
  }
}

fetchData();
</script>
{% endblock %}
